<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="referrer" content="never">
         <meta name="viewport" content="width=device-width, initial-scale=1">
         <link rel="stylesheet" href="iconfont/iconfont.css">
        <style>
            * {margin: 0; padding: 0}
            ul, li {list-style: none;}
            .fm-container {
                color: #222;
                width: 450px;
                height: 800px;
                margin: 10px auto;
                background-color: #d8ddda;
                position: relative;
                overflow: hidden;
            }
            @media(max-width: 480px) {
                .fm-container{
                    position: fixed;
                    top: 0;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    width: auto;
                    margin: 0;
                    min-width: 320px;
                    height: auto;
                }
            }
            .topbar {
                background: linear-gradient(#2c3c35, #313431);
                color: rgb(126,128,126);
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
            }
            .topbar>.prev, .topbar>.next {
                font-size: 1.5em;
                flex-grow: 0;
                flex-shrink: 0;
                color: rgb(126,128,126);
                cursor: pointer;
            }
            .topbar>.prev:hover, .topbar>.next:hover {
                color: #fafcfc;
            }
            
            .channels {
                display: flex;
                justify-content: space-around;
                align-items: center;
                flex-grow: 1;
            }
            .channels {
                cursor: pointer; 
            }    
            .channels>.current-channel {
                color: rgb(233,237,234);
                font-size: 1.2em;
            }
            #main {
                display: flex;
                background-color: #e8edea;
                color: #3f413f;
                padding: 10px;
                position: relative;
            }
            #main>img {
                width: 90px;
                height: 90px;
                display: block;
                flex-grow: 0;
                flex-shrink: 0;
                margin: 20px;
            }
            #main>.detail {
                flex-grow: 1;
                flex-shrink: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                text-align: center;
            }
            #main>.detail>h3  {
                font-size: 0.9em;
            }
            #main>.detail>h3.artist {
                color: #7f8281;
            }
            #main>.detail>h3.title  {
                font-size: 1.1em;
            }
            #main>.detail>.time-line {
                display: flex;
                margin: 3px 15px 3px 8px;
                align-items: center;
            }
            #main>.detail>.time-line>.line {
                height: 3px;
                flex-shrink: 1;
                flex-grow: 1;
                border-radius: 2px;
                background-color: #ced9d3;
                cursor: pointer;
            }
            #main>.detail>.time-line>.line:hover {
                height: 6px;
            }
            #main>.detail>.time-line>.line>.played {
                background-color: #91bdb4;
                width: 50%;
                height: 100%;
                border-radius: 2px;
            }
            #main>.detail>.time-line>.time-left {
                font-size: 0.8em;
                margin: 5px;
                padding: 0 8px;
            }
            #main>.detail>.control {
                display: flex;
                justify-content: space-around;
                font-size: 1em;
            }
            #main>.detail>.control>li {
                cursor: pointer;
            }
            #main>.detail>.control>li:hover {
                opacity: .7;
            }

            #main>.detail>.control>li.volume {
                position: relative;
            }
            #main>.detail>.control>li.like .red{
                color: red;
            }
            #main>.detail>.control>li.volume>.volume-controler {
                box-sizing: content-box;
                position: absolute;
                left: 100%;
                bottom: -100%;
                height: 50px;
                width: 2px;
                background-color: #333;
                border:  5px solid #d8ddda;
                visibility: hidden;
            }
            #main>.detail>.control>li.volume>.volume-controler:hover {
                width: 4px;
            }
                #main>.detail>.control>li.volume>.volume-controler>.volume-height {
                width: 100%;
                height: 0;
                background-color: #ccc;
            }
            #main>.detail>.control>li.volume:hover>.volume-controler {
                visibility: visible;
                opacity: 1;
            }
            .lyric {
                text-align: center;
                padding: 20px;
                margin-right: -20px;
                overflow: scroll;
            }  
            .lyric>li {
                margin: 5px 0;
            }
            .lyric>li.current-line{
                font-weight: bold; 
                color: #518d84;
            } 
            #main>.like-list{
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
            }
            
            #main>.like-list>.open-menu{
                cursor: pointer;
                background-color: #dcece5;
                text-align: center;
                font-size: 0.8em;
                padding: 5px;
            }
            
            #main>.like-list>.playlist{
                display: none;
                cursor: pointer;
                height: 200px;
                width: 100%;
                overflow-y: scroll;
                opacity: 0.85;
                background-color: #eee;
                transform: translate(0, -20px);
            }
            
            #main>.like-list:hover>.playlist{
                display: block;
                transform: translate(0, 0);
                transition: all 0.5s;
            }
            
            #main>.like-list>.playlist>li{
                padding: 3px 20px;
                display: flex;
            }
            
            #main>.like-list>.playlist>li:nth-child(even){
                background-color: #fff;
            }
            #main>.like-list>.playlist>li:nth-child(odd){
                background-color: #eee;
            }

            
            #main>.like-list>.playlist>li:hover{
                color: #518d84;
            }
            
            #main>.like-list>.playlist>li>.list-item-title{
                flex-shrink: 1;
                flex-grow: 1;
            }
            
            #main>.like-list>.playlist>li>.list-item-artist{
                font-size: 14px;
                flex-grow: 0;
                flex-shrink: 0;
                width: 100px;
            }
            
            #main>.like-list>.playlist>li>.delete-song{
                font-size: 14px;
                padding: 3px;
            }
            
            #main>.like-list>.playlist>li>.delete:hover{
                color: firebrick;
            }
            
            
        </style>
    </head>
    <body> 
        <div class="fm-container">
            <div class="topbar">
                <div class="prev"><</div>
                <ul class="channels">
                    <li>我的收藏</li>
                    <li class="current-channel">漫步春天</li>
                    <li>秋日私语</li>
                </ul>
                <div class="next">></div>
            </div>
            <audio src="#"></audio>
            <div id="main">
                <img src="demo.jpg">
                <div class="detail">
                    <h3 class="title">歌名</h3>
                    <h3 class="artist">歌手</h3>
                    <div class="time-line">
                        <div class="line">
                            <div class="played"></div>
                        </div>
                        <div class="time-left">-<span class="minute">00</span>:<span class="second">00</span></div>
                    </div>
                    <ul class="control">
                        <li class="like iconfont icon-like"></li>
                        <li class="play-or-pause iconfont icon-play"></li>
                        <li class="next-song iconfont icon-next"></li>
                        <li class="volume iconfont icon-volume">
                            <div class="volume-controler">                                
                                <div class="volume-height"></div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="like-list">
                    <div class="open-menu iconfont icon-more"></div>
                    <ul class="playlist"></ul>
                </div>
                
            </div>
            <div class="lyric-wrap">
                <ul class="lyric">
                          
                </ul>
            </div>
            <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
            <script>
                (function(){
                    var channels,
                        currentChannels,
                        playing,
                        time,
                        duration,
                        sid

                    var currentChannelsId = 2,
                        lyrics = [],
                        currentSong = {}
                        $audio = $('audio')[0],
                        isSilence = false,
                        isLike = false,
                        // 状态锁
                        isRequesting = false,
                        likeSongsList ={
                            num: 0,
                            songsList:[]
                        }
                $(document).ready(function(){
                    //没有高度无法滚动
                    var lyricBoxHeight = $('.fm-container').innerHeight()-$('#main').outerHeight()-$('.topbar').outerHeight()-60
                    $('.lyric').css('height',lyricBoxHeight+'px');
                    //获频道信息
                    $.get("https://jirenguapi.applinzi.com/fm/getChannels.php")
                    .done(function(response){
                        getChannels(response)
                        loadPlaylist()
                        updateChannels()
                        getMusic()
                    })
                    $('audio').attr('autoplay','true')
                    initPlayerProgress()
                })
                function getChannels(response){
                    channels = JSON.parse(response).channels
                    var favoriteObj = {name:"我的收藏",channel_id:"favorite"}
                    var nullObj = {name:"占四个字",channel_id:""}
                    channels.unshift(favoriteObj)
                    //为了展示我的收藏和最后一个频道
                    channels.unshift(nullObj)
                    channels.push(nullObj)
                    currentChannels = channels.slice(1, 4)
                }
                function initPlayerProgress(){
                    //切换下一个频道
                    $('.next,.channels>li:last').on('click',function(){
                        if(currentChannelsId >= channels.length-2) return
                        currentChannelsId++
                        currentChannels = channels.slice(currentChannelsId-1, currentChannelsId+2)
                        if(!(currentChannels[1].channel_id ==='favorite')){
                            $('.channels>li:first').css('opacity','1')
                        }
                        updateChannels()
                        getMusic()
                    })
                    //切换上一个频道
                    $('.prev,.channels>li:first').on('click',function(){
                        if(currentChannelsId <= 1) return
                        currentChannelsId--
                        currentChannels = channels.slice(currentChannelsId-1, currentChannelsId+2)
                        if(currentChannels[1].channel_id ==='favorite'){
                            $('.channels>li:first').css('opacity','0')
                        }
                        if(currentChannels[1].channel_id === 'favorite'){
                            if(likeSongsList.songsList.length === 0){
                                alert('我的收藏‘还是空的哦，先从别的频道收藏几首喜欢的音乐吧！')
                                currentChannelsId++
                                currentChannels = channels.slice(currentChannelsId-1, currentChannelsId+2)
                                $('.channels>li:first').css('opacity','1')

                            }
                        }                    
                        updateChannels()
                        getMusic()
                    })
                    //换歌
                    $('.next-song').on('click', function(){
                        if(isRequesting) return
                        getMusic();
                    }) 
                    //播放、暂停
                    $('.play-or-pause').on('click',function(){
                        playing ? $('audio')[0].pause():$('audio')[0].play()
                        playing ? $(this).removeClass('icon-play').addClass('icon-pause') : $(this).removeClass('icon-pause').addClass('icon-play')
                        playing = !playing
                    })
                    //监听是否播放完毕
                    $('audio').on('ended', function(){
                        getMusic();
                    })
                    //监听播放位置 
                    var num = 1   
                    $('audio').on('timeupdate',function(){
                        var currentTime = this.currentTime
                        var lastCurrent = $('.lyric>li.current-line:last')
                        var currentOffset = lastCurrent.offset()
                        var lyricTop = $('.lyric-wrap').offset().top
                        var lyricsHeight = $('.lyric-wrap').outerHeight()
                        var lineHeight = $('.lyric').children('li').eq(0).outerHeight()+5
                        
                        lyrics.forEach(function(lyric,index){
                            if( currentTime > lyric.time){
                                highlight(index)
                                    if(currentOffset&&lastCurrent.offset().top-lyricTop>lyricsHeight/2){
                                        $('.lyric').scrollTop(lineHeight*num)
                                        num++                                
                                    }   
                            }
                        }) 
                    })
                    //加载时间
                    $('audio').on('canplay', function(){
                            duration = $audio.duration
                            clock = setInterval(function(){
                                if(time >= Math.floor(duration)){
                                    clearInterval(clock)
                                    return
                                }
                                time = $audio.currentTime;
                                var timeRate = Math.floor(time/duration*100) + '%'
                                $('.played').css('width', timeRate);
                                leftTime(duration - time);
                        }, 1000);
                    })
                    //调节播放进度
                    $('.time-line>.line').on('click', function(e){
                        var position = e.pageX - $(this).offset().left
                        time = position/$(this).innerWidth()*duration
                        $audio.currentTime = time;
                    })
                    //调解音量
                    $('.volume-controler').on('click',function(e){
                        event.stopPropagation()
                        var position = e.pageY - $(this).offset().top
                        volume = (position-5)/50
                        if(volume >=1){
                            loudVolume(volume)
                        }else if(volume <=0){
                            quietVolume(volume)
                        }else{
                            $('audio')[0].volume = 1-volume
                            $(this).children('.volume-height').css('height',volume*100+'%')
                            $('.volume').css('color','#3f413f')
                        }
                    })
                    //直接静音和恢复
                    $('.volume').on('click',function(){
                        isSilence = !isSilence
                        if(!isSilence){
                            quietVolume(0)
                        }else{
                            loudVolume(1)                        
                        }
                    })

                    //收藏歌曲
                    $('.like').on('click',function(){
                        isLike = !isLike
                        console.log(1);
                        if(isLike){
                            $(this).css('color','red')   
                            likeSongsList.songsList.push(currentSong)
                            likeSongsList.num += 1 
                            localStorage.setItem('likeSongs', JSON.stringify(likeSongsList.songsList))
                            loadPlaylist()
                        }else{
                            $(this).css('color','#3f413f')
                            sid = currentSong.sid
                            likeSongsList.songsList.forEach(function(val,index){
                                if(val.sid == sid){
                                    likeSongsList.songsList.splice(index,1) 
                                    localStorage.setItem('likeSongs', JSON.stringify(likeSongsList.songsList))                                
                                } 
                            })                           
                            loadPlaylist()
                        }
                    })
                    //列表中删除收藏歌曲
                    $('.playlist').on('click','li>.delete',function(e){
                        e.stopPropagation()
                        var index = $('.playlist>li>.delete').index($(this))
                        if(likeSongsList.songsList[index].sid == sid){
                            $('.like').css('color','#333')
                            isLike = false
                        }
                        likeSongsList.songsList.splice(index,1)
                        localStorage.setItem('likeSongs', JSON.stringify(likeSongsList.songsList))                    
                        loadPlaylist()
                    })
                    //点击喜欢列表中的歌曲，即播放该歌曲
                    $('.playlist').on('click','li',function(){
                        var listIndex = $('.playlist>li').index($(this))
                        currentSong = likeSongsList.songsList[listIndex]
                        likeSongsList.num = listIndex
                        loadDeatils(currentSong.sid)
                    })
                }
                
                function loadPlaylist(){
                    console.log(JSON.parse(localStorage.getItem('likeSongs')));
                    if(localStorage.getItem('likeSongs')){
                        likeSongsList.songsList =JSON.parse(localStorage.getItem('likeSongs'))
                        var html = ''
                        likeSongsList.songsList.forEach(function(val,index){
                            html += `<li>
                                        <div class="list-item-title">${val.title}</div>
                                        <div class="list-item-artist">${val.artist}</div>
                                        <div class="delete">删除</div>
                                     </li>`
                        })
                        $('.playlist').empty().append(html)
   
                    }
                }
                function loudVolume(volume){
                    $('audio')[0].volume = 0
                    $('.volume-height').css('height','100%')
                    $('.volume').css('color','red')
                }
                function quietVolume(volume){
                    $('audio')[0].volume = 1
                    $('.volume-height').css('height','0')
                    $('.volume').css('color','#3f413f')
                }
                function highlight(index){
                    if(!$('.lyric>li').eq(index).hasClass('current-line')){
                        $('.lyric>li').eq(index).addClass('current-line')
                    }
                }
                //更新频道状态
                function updateChannels(){
                    for(var i=0; i<3; i++){
                        $('.channels>li').eq(i).text(currentChannels[i].name);
                    }
                }
                function getMusic(){
                    var arr = []
                    playing = true
                    isRequesting = true
                    if(currentChannels[1].channel_id === 'favorite'){ 
                        isLike = true
                        $('.like').eq(0).css('color','red')     
                        if(likeSongsList.num<likeSongsList.songsList.length){
                            currentSong = likeSongsList.songsList[likeSongsList.num]
                            likeSongsList.num += 1                           
                        }else if(likeSongsList.songsList.length>0){
                            likeSongsList.num = 0
                            currentSong = likeSongsList.songsList[likeSongsList.num]
                        }else{
                            currentChannelsId++
                            currentChannels = channels.slice(currentChannelsId-1, currentChannelsId+2)
                            $('.channels>li:first').css('opacity','0')
                            alert('我的收藏‘还是空的哦，先从别的频道收藏几首喜欢的音乐吧！')
                            updateChannels()
                            getMusic()
                        }
                        isRequesting = false
                        sid = currentSong.sid;                
                        loadDeatils(sid)                        
                        $('.play-or-pause').removeClass('icon-pause').addClass('icon-play')
                    }else{
                        $.get("https://jirenguapi.applinzi.com/fm/getSong.php",{channel: currentChannels[1].channel_id})
                        .done(function(response){
                            //获取新歌曲时将上一首歌曲的歌词置空
                            num = 1
                            currentSong = JSON.parse(response).song[0]
                            sid = currentSong.sid
                            arr = []
                            isRequesting = false
                            loadDeatils(sid)
                            //获取新歌后将 '.lyric'元素滚动置零
                            $('.lyric').scrollTop(0)
                            playing = true
                            $('.play-or-pause').removeClass('icon-pause').addClass('icon-play')
                            //判断收藏列表中是否存在当前歌曲
                            likeSongsList.songsList.forEach(function(val,index){
                                arr.push(val.sid)
                            })
                            if(arr.indexOf(sid)>-1){
                                console.log(1)
                                isLike = true
                                $('.like').eq(0).css('color','red')
                                console.log(2)
                            }else{
                                isLike = false
                                $('.like').eq(0).css('color','#333')
                            }                   
                        })
                    }
                }
                function loadDeatils(sid){  
                    lyrics = []  
                    $('img').attr("src",currentSong.picture)
                    $('.title').text(currentSong.title)
                    $('.artist').text(currentSong.artist)
                    $('audio').attr('src', currentSong.url)
                    $('.played').css('width','0%') 
                    loadLrc(sid)
                }
                //加载歌词
                function loadLrc(sid){
                    $.get("https://jirenguapi.applinzi.com/fm/getLyric.php",{sid:sid})
                    .done(function(response){
                        parseLyric(JSON.parse(response).lyric)
                        console.log(JSON.parse(response));

                        $('.lyric').html(lyrics)
                        renderLrc()                  
                    })
                }
                //解析歌词
                function parseLyric(lrc) {
                    var lyricsArr = lrc.split("\n")
                    lyricsArr.forEach(function(lyrItem,index){
                        // var lrcArr = []
                        var lyrObj = {}
                        var timeReg = /\[(?:\d+:)\d+.\d+]/g,
                            lyrReg = /\][^\[].*/g
                           
                        var timeRegArr = lyrItem.match(timeReg)
                        var lrcRegArr = lyrItem.match(/\][^\[].*/g)
                        var content = lyrItem.replace(timeReg,'')
                        if(timeRegArr!==null){
                            timeRegArr.forEach(function(timeItem){
                            var minute = Number(String(timeItem.match(/\[\d*/i)).slice(1)),
                                second = Number(String(timeItem.match(/\:\d*/i)).slice(1)),
                                time = minute * 60 + second
                                if(lrcRegArr !== null){
                                    lyrObj.time =  time
                                    lyrObj.content = content
                                }
                                 console.log(lyrObj);
                           })
                        }
                        //api返回的歌词存在“[00:02:00][01:02:00] 同一句歌词”，改用{'时间','歌词'}保存歌词数据
                        //获得{'时间','歌词'}
                        if(!$.isEmptyObject(lyrObj) && lyrObj.time !== 0){
                            lyrics.push(lyrObj);
                        }
                    })
                    lyrics.sort(function(a,b){
                        return a.time-b.time;
                    })
                    return lyrics
                }
                
                function renderLrc(){
                    $('.lyric').empty()
                    $.each(lyrics,function(key,val){
                        var html = `<li>${val.content}</li>`
                        $('.lyric').append(html)
                    })
                }
                //展示歌曲剩余时间
                function leftTime(num){
                    var timeNum = Math.floor(num);
                    var second = timeNum%60;
                    var minute = Math.floor(timeNum/60);
                    if(minute<10){
                        $('.minute').html('0'+minute);
                    }
                    else{
                        $('.minute').html(miminuten);
                    }
                    if(second<10){
                        $('.second').html('0'+second);
                    }
                    else{
                        $('.second').html(second);
                    }                    
                }
                })()
            </script>
        </div>
    </body>
</html>